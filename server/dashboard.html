<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RNNoise Monitor</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: #0d1117; color: #c9d1d9;
  font-family: 'Segoe UI', monospace;
  padding: 14px; font-size: 13px;
}
h1 { text-align: center; color: #58a6ff; font-size: 1.1rem;
     margin-bottom: 12px; letter-spacing: 1px; }

/* ‚îÄ‚îÄ DIAGNOSTIC PANEL ‚Äî always visible ‚îÄ‚îÄ */
#diag {
  background: #0d1117; border: 1px solid #30363d; border-radius: 7px;
  padding: 10px 14px; margin-bottom: 12px;
}
#diag h2 { font-size: 0.75rem; color: #8b949e; margin-bottom: 6px;
           text-transform: uppercase; letter-spacing: 1px; }
.drow { display: flex; align-items: center; gap: 8px;
        padding: 3px 0; font-size: 0.8rem; border-bottom: 1px solid #161b22; }
.drow:last-child { border-bottom: none; }
.dstep { width: 180px; color: #8b949e; flex-shrink: 0; }
.dval  { flex: 1; }
.ok    { color: #3fb950; }
.fail  { color: #f85149; }
.wait  { color: #d29922; }

/* Status bar */
#statusbar {
  display: flex; gap: 20px; flex-wrap: wrap; align-items: center;
  background: #161b22; border: 1px solid #30363d; border-radius: 6px;
  padding: 8px 14px; margin-bottom: 12px;
}
.dot { display: inline-block; width: 9px; height: 9px; border-radius: 50%;
       background: #444; margin-right: 5px; vertical-align: middle; }
.dot.green  { background: #3fb950; box-shadow: 0 0 6px #3fb950; }
.dot.red    { background: #f85149; }
.dot.yellow { background: #d29922; }

/* Panels */
.grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
.panel { background: #161b22; border: 1px solid #30363d; border-radius: 7px; padding: 10px; }
.ptitle { font-size: 0.68rem; text-transform: uppercase; letter-spacing: 1px;
          color: #8b949e; margin-bottom: 7px; }

/* STFT heatmap */
#stft-wrap { position: relative; width: 100%; height: 180px;
             background: #0a0a0a; border-radius: 4px; overflow: hidden; }
#stft-canvas { position: absolute; top: 0; left: 0;
               width: 100%; height: 100%; image-rendering: pixelated; }
#stft-ph { position: absolute; top: 50%; left: 50%;
           transform: translate(-50%,-50%);
           color: #8b949e; font-size: 0.8rem; pointer-events: none; }
.freq-labels { display: flex; justify-content: space-between;
               font-size: 0.63rem; color: #8b949e; margin-top: 3px; }

/* Metrics */
.mgrid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
.metric { background: #0d1117; border-radius: 5px; padding: 8px 10px; }
.metric .lbl { font-size: 0.66rem; color: #8b949e; margin-bottom: 2px; }
.metric .val { font-size: 1.1rem; font-weight: bold; color: #58a6ff; }
.metric .val.good { color: #3fb950; }
.metric .val.warn { color: #d29922; }
.metric .val.bad  { color: #f85149; }

/* Log */
#log-wrap { background: #161b22; border: 1px solid #30363d; border-radius: 7px;
            padding: 10px; margin-top: 10px; }
#log-box  { max-height: 130px; overflow-y: auto; }
.le { font-size: 0.72rem; line-height: 1.7; border-bottom: 1px solid #0d1117; padding: 0 2px; }
.le.info  { color: #58a6ff; }  .le.good { color: #3fb950; }
.le.warn  { color: #d29922; }  .le.err  { color: #f85149; }

@media (max-width: 700px) { .grid2 { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<h1>üéô RNNoise Monitor ‚Äî ESP32-S3</h1>

<!-- ‚îÄ‚îÄ Diagnostic panel ‚îÄ‚îÄ -->
<div id="diag">
  <h2>üîç Self-Diagnostic</h2>
  <div class="drow"><span class="dstep">1. Page loaded</span>
    <span class="dval ok" id="d1">‚úì HTML rendered</span></div>
  <div class="drow"><span class="dstep">2. Chart.js loaded</span>
    <span class="dval wait" id="d2">‚è≥ checking‚Ä¶</span></div>
  <div class="drow"><span class="dstep">3. Canvas elements</span>
    <span class="dval wait" id="d3">‚è≥ checking‚Ä¶</span></div>
  <div class="drow"><span class="dstep">4. Charts created</span>
    <span class="dval wait" id="d4">‚è≥ checking‚Ä¶</span></div>
  <div class="drow"><span class="dstep">5. WebSocket connect</span>
    <span class="dval wait" id="d5">‚è≥ connecting to <span id="d5-url"></span></span></div>
  <div class="drow"><span class="dstep">6. Handshake / config</span>
    <span class="dval wait" id="d6">‚è≥ waiting‚Ä¶</span></div>
  <div class="drow"><span class="dstep">7. First audio frame</span>
    <span class="dval wait" id="d7">‚è≥ waiting‚Ä¶</span></div>
  <div class="drow"><span class="dstep">8. STFT rendered</span>
    <span class="dval wait" id="d8">‚è≥ waiting‚Ä¶</span></div>
</div>

<!-- Status bar -->
<div id="statusbar">
  <span><span class="dot" id="dot-ws"></span><span id="lbl-ws">Server: connecting‚Ä¶</span></span>
  <span><span class="dot" id="dot-esp"></span><span id="lbl-esp">ESP32: waiting</span></span>
  <span>üì¶ RX: <b id="s-frames">0</b></span>
  <span>‚ö° <b id="s-fps">--</b> fps</span>
  <span>‚è± <b id="s-uptime">0</b>s</span>
  <span>üîß DSP: <b id="s-dsp">--</b>ms</span>
</div>

<!-- Waveform + Metrics -->
<div class="grid2">
  <div class="panel">
    <div class="ptitle">üìà Waveform ‚Äî Raw PCM</div>
    <canvas id="c-wave" height="90"></canvas>
  </div>
  <div class="panel">
    <div class="ptitle">üìã Live Metrics</div>
    <div class="mgrid">
      <div class="metric"><div class="lbl">SNR</div>
        <div class="val" id="m-snr">-- dB</div></div>
      <div class="metric"><div class="lbl">VAD Probability</div>
        <div class="val" id="m-vad">--</div></div>
      <div class="metric"><div class="lbl">Frames RX / TX</div>
        <div class="val" id="m-frames">--</div></div>
      <div class="metric"><div class="lbl">Render latency</div>
        <div class="val" id="m-lat">-- ms</div></div>
    </div>
  </div>
</div>

<!-- STFT Spectrogram -->
<div class="panel" style="margin-bottom:10px">
  <div class="ptitle">üåà STFT Spectrogram ‚Äî time (x) ¬∑ frequency (y, 0‚Äì24kHz)</div>
  <div id="stft-wrap">
    <canvas id="stft-canvas"></canvas>
    <div id="stft-ph">Waiting for audio data‚Ä¶</div>
  </div>
  <div class="freq-labels">
    <span>0 Hz</span><span>6 kHz</span><span>12 kHz</span>
    <span>18 kHz</span><span>24 kHz</span>
  </div>
</div>

<!-- Bark + SNR history -->
<div class="grid2">
  <div class="panel">
    <div class="ptitle">üéõ Bark Band Energies ‚Äî 22 bands</div>
    <canvas id="c-bark" height="120"></canvas>
  </div>
  <div class="panel">
    <div class="ptitle">üìä SNR History (dB)</div>
    <canvas id="c-snr" height="120"></canvas>
  </div>
</div>

<!-- Event log -->
<div id="log-wrap">
  <div class="ptitle" style="margin-bottom:6px">üñ• Event Log</div>
  <div id="log-box"></div>
</div>

<!-- Chart.js loaded AFTER DOM so canvases exist -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"
        onerror="diagFail('d2','‚úó Failed to load Chart.js from CDN ‚Äî check internet connection')">
</script>
<script>
'use strict';

// ‚îÄ‚îÄ diagnostic helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function diagOK(id, msg)   { const e = document.getElementById(id); e.className='dval ok';   e.textContent='‚úì '+msg; }
function diagFail(id, msg) { const e = document.getElementById(id); e.className='dval fail'; e.textContent='‚úó '+msg; }
function diagWait(id, msg) { const e = document.getElementById(id); e.className='dval wait'; e.textContent='‚è≥ '+msg; }

// ‚îÄ‚îÄ event log ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const logBox = document.getElementById('log-box');
function clog(msg, kind='info') {
  const t   = new Date().toTimeString().slice(0,8);
  const div = document.createElement('div');
  div.className   = 'le ' + kind;
  div.textContent = `[${t}] ${msg}`;
  logBox.prepend(div);
  while (logBox.children.length > 50) logBox.removeChild(logBox.lastChild);
  console.log(`[${kind}] ${msg}`);
}

// ‚îÄ‚îÄ Step 2: Chart.js check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if (typeof Chart === 'undefined') {
  diagFail('d2', '‚úó Chart.js not loaded ‚Äî CDN unreachable?');
  clog('Chart.js failed to load from CDN', 'err');
} else {
  diagOK('d2', `Chart.js v${Chart.version}`);
  clog(`Chart.js v${Chart.version} loaded`, 'good');
}

// ‚îÄ‚îÄ Step 3: canvas elements ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const canvasIds = ['c-wave','c-bark','c-snr','stft-canvas'];
const missing = canvasIds.filter(id => !document.getElementById(id));
if (missing.length > 0) {
  diagFail('d3', `Missing canvas elements: ${missing.join(', ')}`);
  clog(`Missing canvas: ${missing.join(', ')}`, 'err');
} else {
  diagOK('d3', `All ${canvasIds.length} canvas elements found`);
}

// ‚îÄ‚îÄ Step 4: create charts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let chartWave, chartSnr, chartBark;
let chartsOK = false;

try {
  function mkLine(id, color, yMin, yMax, pts) {
    const ctx = document.getElementById(id).getContext('2d');
    return new Chart(ctx, {
      type: 'line',
      data: {
        labels: Array(pts).fill(''),
        datasets: [{ data: Array(pts).fill(null),
                     borderColor: color, borderWidth: 1.5,
                     pointRadius: 0, fill: false, tension: 0.2 }]
      },
      options: {
        animation: false, responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { display: false },
          y: { min: yMin, max: yMax,
               grid:  { color: '#21262d' },
               ticks: { color: '#8b949e', font: { size: 10 }, maxTicksLimit: 5 } }
        }
      }
    });
  }

  function mkBar(id, color, nBands) {
    const ctx    = document.getElementById(id).getContext('2d');
    const labels = Array.from({length: nBands}, (_, i) => `B${i+1}`);
    return new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{ data: Array(nBands).fill(-80),
                     backgroundColor: color, borderRadius: 2 }]
      },
      options: {
        animation: false, responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#8b949e', font: { size: 9 } }, grid: { color: '#21262d' } },
          y: { min: -80, max: 0,
               ticks: { color: '#8b949e', font: { size: 9 },
                        callback: v => v+'dB', maxTicksLimit: 5 },
               grid: { color: '#21262d' } }
        }
      }
    });
  }

  // int16 PCM: -32768 to +32767
  chartWave = mkLine('c-wave', 'rgba(88,166,255,0.9)',  -32768, 32767, 240);
  chartSnr  = mkLine('c-snr',  'rgba(210,153,34,0.9)',  -20,    60,    100);
  chartBark = mkBar ('c-bark', 'rgba(63,185,80,0.8)',   22);

  chartsOK = true;
  diagOK('d4', 'waveform + SNR + bark charts ready');
  clog('All 3 charts created OK', 'good');

} catch(e) {
  diagFail('d4', `Chart creation failed: ${e.message}`);
  clog(`Chart init error: ${e.message}`, 'err');
}

// Rolling data arrays
const waveArr = new Array(240).fill(0);
const snrArr  = new Array(100).fill(null);

function pushLine(chart, arr, newVals) {
  for (const v of newVals) { arr.push(v); arr.shift(); }
  chart.data.datasets[0].data = arr.slice();
  chart.update('none');
}
function setBar(chart, vals) {
  chart.data.datasets[0].data = vals;
  chart.update('none');
}
function setMetric(id, text, cls) {
  const el = document.getElementById(id);
  el.textContent = text;
  el.className   = 'val' + (cls ? ' ' + cls : '');
}

// ‚îÄ‚îÄ STFT colormap LUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CMAP_N = 512;
const CMAP   = new Uint8Array(CMAP_N * 3);
(function() {
  const stops = [
    [0.00, [13,  17,  23 ]],
    [0.20, [0,   30,  100]],
    [0.45, [0,   130, 200]],
    [0.60, [0,   200, 180]],
    [0.75, [50,  200, 50 ]],
    [0.88, [220, 200, 0  ]],
    [1.00, [240, 50,  20 ]],
  ];
  for (let i = 0; i < CMAP_N; i++) {
    const t = i / (CMAP_N - 1);
    let lo = stops[0], hi = stops[stops.length-1];
    for (let j = 0; j < stops.length-1; j++) {
      if (t >= stops[j][0] && t <= stops[j+1][0]) { lo=stops[j]; hi=stops[j+1]; break; }
    }
    const f = (t - lo[0]) / ((hi[0]-lo[0]) || 1);
    CMAP[i*3]   = Math.round(lo[1][0] + f*(hi[1][0]-lo[1][0]));
    CMAP[i*3+1] = Math.round(lo[1][1] + f*(hi[1][1]-lo[1][1]));
    CMAP[i*3+2] = Math.round(lo[1][2] + f*(hi[1][2]-lo[1][2]));
  }
})();

const stftCanvas = document.getElementById('stft-canvas');
const stftCtx    = stftCanvas.getContext('2d');
const stftPH     = document.getElementById('stft-ph');
let   stftDrawn  = false;
const DB_MIN = -100, DB_MAX = -10;

function drawStft(data) {
  if (!data || data.length === 0) return;
  const nF = data.length;
  const nT = data[0]?.length ?? 0;
  if (nT === 0) { clog('STFT: nFrames=0, skipping draw', 'warn'); return; }

  stftCanvas.width  = nT;
  stftCanvas.height = nF;

  const img = stftCtx.createImageData(nT, nF);
  const buf = img.data;
  const range = DB_MAX - DB_MIN;

  for (let fi = 0; fi < nF; fi++) {
    const row = nF - 1 - fi;   // low freq at bottom
    for (let t = 0; t < nT; t++) {
      const n   = Math.max(0, Math.min(CMAP_N-1,
                    Math.round((data[fi][t] - DB_MIN) / range * (CMAP_N-1))));
      const idx = (row * nT + t) * 4;
      buf[idx]   = CMAP[n*3];
      buf[idx+1] = CMAP[n*3+1];
      buf[idx+2] = CMAP[n*3+2];
      buf[idx+3] = 255;
    }
  }
  stftCtx.putImageData(img, 0, 0);

  if (!stftDrawn) {
    stftDrawn = true;
    stftPH.style.display = 'none';
    diagOK('d8', `${nF} freq bins √ó ${nT} time frames`);
    clog(`STFT drawn: ${nF}√ó${nT} (nfft=${nF*2-2})`, 'good');
  }
}

// ‚îÄ‚îÄ WebSocket ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const WS_URL = `ws://${location.hostname}:8765/ws/browser`;
document.getElementById('d5-url').textContent = WS_URL;
clog(`Connecting to ${WS_URL}‚Ä¶`);

let ws, fpsCount = 0, fpsTimer = null, firstFrame = true;

function wsConnect() {
  diagWait('d5', `connecting to ${WS_URL}‚Ä¶`);
  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    diagOK('d5', `connected to ${WS_URL}`);
    document.getElementById('dot-ws').className = 'dot green';
    document.getElementById('lbl-ws').textContent = 'Server: connected';
    clog('WebSocket connected', 'good');
    fpsTimer = setInterval(() => {
      document.getElementById('s-fps').textContent = fpsCount;
      fpsCount = 0;
    }, 1000);
  };

  ws.onclose = ev => {
    diagFail('d5', `closed (code=${ev.code} reason="${ev.reason || 'none'}")`);
    document.getElementById('dot-ws').className = 'dot red';
    document.getElementById('lbl-ws').textContent = 'Server: disconnected';
    clog(`WS closed code=${ev.code} ‚Äî retry in 2s`, 'warn');
    clearInterval(fpsTimer);
    setTimeout(wsConnect, 2000);
  };

  ws.onerror = () => {
    diagFail('d5', `connection error ‚Äî is server running on port 8765?`);
    clog('WS error ‚Äî server not reachable on port 8765?', 'err');
  };

  ws.onmessage = ev => {
    const t0 = performance.now();
    let msg;
    try { msg = JSON.parse(ev.data); }
    catch(e) { clog(`JSON parse error: ${e.message}`, 'err'); return; }

    if (msg.type === 'esp32_config') {
      diagOK('d6', `rate=${msg.sample_rate} frame=${msg.frame_size} model=${msg.ai_model}`);
      document.getElementById('dot-esp').className  = 'dot yellow';
      document.getElementById('lbl-esp').textContent = `ESP32: ${msg.sample_rate}Hz`;
      clog(`ESP32 handshake: ${JSON.stringify(msg)}`, 'good');
      return;
    }

    if (msg.type !== 'frame_update') {
      clog(`Unknown msg type: "${msg.type}"`, 'warn');
      return;
    }

    fpsCount++;

    if (firstFrame) {
      firstFrame = false;
      diagOK('d7',
        `waveform=${msg.waveform?.length}pts ` +
        `stft=(${msg.stft_db?.length ?? 0}√ó${msg.stft_db?.[0]?.length ?? 0}) ` +
        `bark=${msg.bark_bands?.length ?? 0}`
      );
      diagWait('d6', diagWait('d6','waiting for esp32_config broadcast') || '');
      document.getElementById('dot-esp').className  = 'dot green';
      document.getElementById('lbl-esp').textContent = 'ESP32: streaming ‚úì';
      clog(`First frame: waveform=${msg.waveform?.length} stft_freqs=${msg.stft_db?.length} bark=${msg.bark_bands?.length}`, 'good');
    }

    // Waveform
    if (msg.waveform?.length > 0 && chartsOK) {
      pushLine(chartWave, waveArr, msg.waveform);
    }

    // STFT
    if (msg.stft_db?.length > 0) {
      drawStft(msg.stft_db);
    } else if (firstFrame === false && !stftDrawn) {
      clog('STFT data empty in frame ‚Äî history too short?', 'warn');
    }

    // Bark
    if (msg.bark_bands?.length === 22 && chartsOK) {
      setBar(chartBark, msg.bark_bands);
    } else if (msg.bark_bands && msg.bark_bands.length !== 22) {
      clog(`Bark: got ${msg.bark_bands.length} bands, expected 22`, 'warn');
    }

    // SNR history
    if (msg.snr_history?.length > 0 && chartsOK) {
      const src = msg.snr_history.slice(-100);
      snrArr.fill(null);
      for (let i = 0; i < src.length; i++) snrArr[100 - src.length + i] = src[i];
      chartSnr.data.datasets[0].data = snrArr.slice();
      chartSnr.update('none');
    }

    // Metrics
    const snr = msg.snr_db ?? 0;
    setMetric('m-snr', snr.toFixed(1) + ' dB',
      snr > 15 ? 'good' : snr > 5 ? 'warn' : 'bad');

    const vad = msg.vad_prob ?? 0;
    setMetric('m-vad', vad.toFixed(3),
      vad > 0.7 ? 'good' : vad > 0.3 ? 'warn' : '');

    setMetric('m-frames',
      `${msg.stats?.frames_rx ?? '--'} / ${msg.stats?.frames_tx ?? '--'}`);
    setMetric('m-lat', (performance.now() - t0).toFixed(1) + ' ms');

    document.getElementById('s-frames').textContent = msg.stats?.frames_rx ?? 0;
    document.getElementById('s-uptime').textContent = msg.stats?.uptime_s   ?? 0;
    document.getElementById('s-dsp').textContent    = (msg.dsp_ms ?? 0).toFixed(1);
  };
}

wsConnect();
clog('Dashboard init complete');
</script>
</body>
</html>
